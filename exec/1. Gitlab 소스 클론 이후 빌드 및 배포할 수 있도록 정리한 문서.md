# ëª©ì°¨
1. [ì„œë²„ í™˜ê²½ ë° ì„¤ì • ê°’](#ì„œë²„-í™˜ê²½-ë°-ì„¤ì •-ê°’)
2. [ë¹Œë“œ ì‹œ ì‚¬ìš©ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜](#ë¹Œë“œ-ì‹œ-ì‚¬ìš©ë˜ëŠ”-í™˜ê²½-ë³€ìˆ˜)
3. [DB ì ‘ì† ì •ë³´](#DB-ì ‘ì†-ì •ë³´)
4. [Jenkins íŒŒì´í”„ë¼ì¸](#Jenkins-íŒŒì´í”„ë¼ì¸)
5. [ë°°í¬ ì‹œ íŠ¹ì´ì‚¬í•­](#ë°°í¬-ì‹œ-íŠ¹ì´ì‚¬í•­)

# ì„œë²„ í™˜ê²½ ë° ì„¤ì • ê°’

- deploy EC2
    ```
    OS: Ubuntu 22.04.4 LTS x86_64
    Host: HVM domU 4.11.amazon
    Kernel: 6.8.0-1024-aws
    Uptime: 22 days, 5 hours, 49 mins
    Packages: 780 (dpkg), 9 (snap)
    Shell: bash 5.1.16
    Terminal: /dev/pts/0
    CPU: Intel Xeon E5-2686 v4 (4) @ 2.299GHz
    GPU: 00:02.0 Cirrus Logic GD 5446
    Memory: 3439MiB / 15990MiB
    ```
- monitoring EC2
  ```
    OS: Ubuntu 22.04.4 LTS x86_64
    Host: HVM domU 4.11.amazon
    Kernel: 6.8.0-1024-aws
    Uptime: 22 days, 5 hours, 49 mins
    Packages: 780 (dpkg), 9 (snap)
    Shell: bash 5.1.16
    Terminal: /dev/pts/0
    CPU: Intel Xeon E5-2686 v4 (4) @ 2.299GHz
    GPU: 00:02.0 Cirrus Logic GD 5446
    Memory: 3439MiB / 15990MiB
  ```
- docker
  ```
  Version:           28.1.1
  API version:       1.49
  Go version:        go1.23.8
  Git commit:        4eba377
  Built:             Fri Apr 18 09:52:10 2025
  OS/Arch:           linux/amd64
  Context:           default
  ```
- deploy EC2's ./nginx/default.conf
  ```
  server {
        listen 80 default_server;
        listen [::]:80 default_server;

        server_name ë² í¬ë„ë©”ì¸ëª…;

        location /.well-known/acme-challenge/ {
                root /var/www/letsencrypt;
                #allow all;
        }

        location / {
                return 301 https://$host$request_uri;
        }
  }

  server {
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;

        root /usr/share/nginx/html;
        index index.html;

        server_name ë² í¬ë„ë©”ì¸ëª…;

        ssl_certificate /etc/letsencrypt/live/ë² í¬ë„ë©”ì¸ëª…/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/ë² í¬ë„ë©”ì¸ëª…/privkey.pem;

        location / {
                try_files $uri /index.html;
        }

        location /jenkins {
                proxy_http_version  1.1;
                proxy_set_header    Upgrade $http_upgrade;
                proxy_set_header    Connection "Upgrade";

                proxy_set_header    Host $host;
                proxy_set_header    X-Real-IP $remote_addr;
                proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header    X-Forwarded-Proto $scheme;
                proxy_set_header    X-Forwarded-Host $host;
                proxy_set_header    X-Forwarded-Port 443;

                proxy_pass_header   Authorization;
                proxy_set_header    Authorization $http_authorization;
                proxy_set_header    X-NginX-Proxy true;

                proxy_pass          http://jenkins:8080/jenkins/;
                proxy_redirect      ~^/jenkins/jenkins /jenkins;
                proxy_cookie_path   ~^/jenkins/jenkins /jenkins;

                proxy_buffering     off;
                proxy_request_buffering off;
        }

        location ~ ^/(oauth2|login|api) {


                if ($request_method = OPTIONS) {
                        add_header Access-Control-Allow-Origin *;
                        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE, PATCH";
                        add_header Access-Control-Allow-Headers "Authorization, Content-Type";
                        add_header Content-Length 0;
                        add_header Content-Type text/plain;
                        return 204;
                }

                proxy_set_header    Host $host;
                proxy_set_header    X-Real-IP $remote_addr;
                proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header    X-Forwarded-Proto $scheme;
                proxy_set_header    Authorization $http_authorization;
                proxy_set_header    X-NginX-Proxy true;

                add_header          Access-Control-Expose-Headers Authorization;
                proxy_pass_header   Set-Cookie;
                proxy_pass_request_headers on;
                proxy_set_header Content-Type "application/json";

                proxy_pass          http://backend:8080;
                proxy_redirect      off;
                charset             utf-8;
        }
  }
  ```
- deploy EC2's Docker Bridge Network ìƒì„±
  ```
  docker network create backend-net
  docker network create jenkins-net
  docker network create app-net
  ```
- deploy EC2's ./docker-compose.yml
  ```
  services:
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - /var/www/letsencrypt:/var/www/letsencrypt
      - /etc/letsencrypt:/etc/letsencrypt
    entrypoint: >
      sh -c 'certbot certonly --webroot
      --webroot-path=/var/www/letsencrypt
      -d ë°°í¬ë„ë©”ì¸ëª…
      --email ì´ë©”ì¼
      --agree-tos
      --non-interactive'

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx:/etc/nginx/conf.d
      - /var/www/letsencrypt:/var/www/letsencrypt
      - /etc/letsencrypt:/etc/letsencrypt
    networks:
      - default
      - jenkins-net
      - app-net
    restart: unless-stopped

  jenkins:
    image: jenkins/jenkins:jdk21
    container_name: jenkins
    environment:
      - JENKINS_OPTS="--prefix=/jenkins"
      - JAVA_OPTS="-Djenkins.model.Jenkins.crumbIssuerProxyCompatibility=true"
      - JENKINS_URL="https://ë² í¬ë„ë©”ì¸ëª…/jenkins"
    volumes:
      - jenkins_data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    ports:
      - 50000:50000
    networks:
      - jenkins-net
    user: "1000:999"

  minio:
    image: minio/minio:latest
    container_name: minio
    volumes:
      - minio_data:/data
      - ./minio_certs:/root/.minio/certs
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=ë£¨íŠ¸ìœ ì €ëª…
      - MINIO_ROOT_PASSWORD=ë£¨íŠ¸ë¹„ë°€ë²ˆí˜¸
      - MINIO_SERVER_URL=https://ë² í¬ë„ë©”ì¸ëª…:8010
      - MINIO_BROWSER_REDIRECT_URL=https://ë² í¬ë„ë©”ì¸ëª…:8011
    ports:
      - "8010:9000"
      - "8011:9001"

  networks:
      jenkins-net:
        external: true
      app-net:
        external: true
  
  volumes:
      jenkins_data:
      minio_data:
  ```
- monitoring EC2's ./loki/loki-config.yml
  ```
  auth_enabled: false

  server:
      http_listen_port: 3100
      grpc_listen_port: 9096

  common:
    instance_addr: 127.0.0.1
    path_prefix: /tmp/loki
    storage:
      filesystem:
        chunks_directory: /tmp/loki/chunks
        rules_directory: /tmp/loki/rules
      replication_factor: 1
      ring:
        kvstore:
          store: inmemory

  query_range:
    results_cache:
      cache:
        embedded_cache:
          enabled: true
          max_size_mb: 100

  schema_config:
    configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

  ruler:
    alertmanager_url: http://localhost:9093
  ```
- monitoring EC2's ./prometheus/prometheus.yml
  ```
  global:
    scrape_interval: 15s
    scrape_timeout: 15s

  scrape_configs:
    - job_name: "prometheus"
    static_configs:
      - targets:
        - "prometheus:9090"
    - job_name: "springboot"
      scheme: "https"
      metrics_path: "/api/actuator/prometheus"
      scrape_interval: 5s
      static_configs:
        - targets:
          - "ë² í¬ë„ë©”ì¸ëª…"
    ```
- monitoring EC2's ./docker-compose.yml
  ```
  services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana-storage:/var/lib/grafana

  loki:
    image: grafana/loki:2.9.7
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki/loki-config.yml:/etc/loki/local-config.yaml

  volumes:
      grafana-storage:
  ```
- deploy EC2's mariaDB
  ```
  docker run -d --name mariaDB \
  --network backend-net -p 3306:3306 \
  -e MARIADB_ROOT_PASSWORD=ë£¨íŠ¸ë¹„ë°€ë²ˆí˜¸ \
  -e MARIADB_USER=ìœ ì €ëª… \
  -e MARIADB_PASSWORD=ìœ ì €ë¹„ë°€ë²ˆí˜¸ \
  -e MARIADB_DATABASE=spico \
  -v db_data:/var/lib/mysql \
  --restart unless-stopped \
  -e TZ=Asia/Seoul mariadb
  ```

# ë¹Œë“œ ì‹œ ì‚¬ìš©ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜
- Backend: .env
  
  | ID                         | Describe                         |
  |----------------------------|----------------------------------|
  | SPRING_DATASOURCE_USERNAME | mariaDB ìœ ì €ëª…                      |
  | SPRING_DATASOURCE_PASSWORD | mariaDB ìœ ì € ë¹„ë°€ë²ˆí˜¸                  |
  | SPRING_DATASOURCE_URL      | mariaDB URL                      |
  | OPENAI_API_KEY             | ChatGPT API Key                  |
  | ENDPOINT                   | MinIO URL                        |
  | ACCESS_KEY                 | MinIO Access Key                 |
  | SECRET_KEY                 | MinIO Secret Key                 |
  | NEWS_API_KEY               | DeepSearch API Key               |
  | JWT_SECRET                 | JWT Access Token ìƒì„±ìš© Secret Seed |

- Android: local.properties

  | ID                         | Describe                    |
  |----------------------------|-----------------------------|
  | sdk.dir                    | Android sdk ì„¤ì¹˜ ê²½ë¡œ           |
  | kakao.native.app.key       | Kakao Oauth2 ì¸ì¦ì„ ìœ„í•œ App Key |
  | azure.key                  | Azure STT ì‚¬ìš©ì„ ìœ„í•œ Key        |
  | azure.region               | Azure ì„œë¹„ìŠ¤ ì‚¬ìš© ë¦¬ì „             |
  | openai.key                 | ChatGPT API Key             |

# DB ì ‘ì† ì •ë³´
- mariaDB ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ì ‘ì† ì‹œ `docker exec -it  mariaDB mariadb -u ìœ ì €ëª… -p` ì…ë ¥ í›„ ë‹¤ìŒ ì¤„ì— ìœ ì €ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•œë‹¤.

# Jenkins íŒŒì´í”„ë¼ì¸
- Jenkins Credentials

  | ID                          | Kind                          | Describe                              |
  |-----------------------------|-------------------------------|---------------------------------------|
  | gitlab-account              | Username with password        | gitlab idì™€ password                   |
  | gitlab-project-access-token | GitLab API token              | gitlab project access token           |
  | ssafy-ec2-ssh               | SSH Username with private key | deploy EC2ì˜ username(ubuntu)ê³¼ pem key |
  | docker-hub-credentials	     | Username with password        | docker hub idì™€ security access token  |
  | ec2-user                    | Secret text                   | deploy EC2ì˜ username(ubuntu)          |
  | ec2-host                    | Secret text                   | deploy EC2ì˜ ë„ë©”ì¸ëª…                      |
  | android-properties          | Secret file                   | Androidì˜ local.properties íŒŒì¼          |
  | backend-env                 | Secret file                   | Backendì˜ .env íŒŒì¼                      |

- Back-CI
  - Source Branch Regex: `.*`
  - Target Branch Regex: `^dev-be$`
  ```
  pipeline {
    agent any
    stages {
        stage('Checkout') {
            steps {
                script {
                    updateGitlabCommitStatus name: 'checkout', state: 'pending'
                    updateGitlabCommitStatus name: 'check-conflicts', state: 'pending'
                    updateGitlabCommitStatus name: 'build-jar', state: 'pending'
                    
                    def sourceBranch = env.gitlabSourceBranch
                    def targetBranch = env.gitlabTargetBranch
                    echo "MR Source Branch: ${sourceBranch}"
                    echo "MR Target Branch: ${targetBranch}"

                    checkout([$class: 'GitSCM',
                            branches: [[name: "*/${targetBranch}"]],
                            userRemoteConfigs: [[
                                url: 'https://lab.ssafy.com/s12-final/S12P31A401.git',
                                credentialsId: 'gitlab-account',
                                refspec: "+refs/heads/${sourceBranch}:refs/remotes/origin/${sourceBranch} +refs/heads/${targetBranch}:refs/remotes/origin/${targetBranch}"
                            ]]
                    ])
                    
                    updateGitlabCommitStatus name: 'checkout', state: 'success'
                    
                    sh '''
                    git config user.name "ci-bot"
                    git config user.email "ci@example.com"
                    '''

                    def mergeExitCode = sh(script: "git merge origin/${sourceBranch} --no-ff --no-commit --no-edit", returnStatus: true)
                    if (mergeExitCode != 0) {
                        error("âŒ Merge conflict ë°œìƒ: ${sourceBranch} â†’ ${targetBranch}")
                    } else {
                        echo "âœ… Merge ì„±ê³µ! ë¹Œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
                        updateGitlabCommitStatus name: 'check-conflicts', state: 'success'
                    }
                }
            }
        } // stage
        
        stage('Build JAR') {
            steps {
                script {
                    echo "âœ… Gradle í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹œì‘"
    
                    sh '''
                    cd spicoBackend
                    chmod +x gradlew
                    ./gradlew clean processResources bootJar -x test
                    '''
                    
					echo "âœ… ë¹Œë“œ ì™„ë£Œ"
                    updateGitlabCommitStatus name: 'build-jar', state: 'success'
                }
            }
        } // stage
    } // stages
    
    post {
        success {
            script {
                def mrTitle = env.gitlabMergeRequestTitle ?: " "
                def mrId = env.gitlabMergeRequestIid
                def projectUrl = 'https://lab.ssafy.com/s12-final/S12P31A401'
                def mrUrl = "${projectUrl}/-/merge_requests/${mrId}"
                def msg = "âœ… BACKEND CI ì„±ê³µ <${env.BUILD_URL}|#${env.BUILD_NUMBER}>\n <${mrUrl}|${mrTitle}>"
                mattermostSend(color: 'good',
                    message: msg,
                    endpoint: 'Mattermost ì±„ë„ Webhook'
                )
            }
        }
        failure {
            script {
                def mrTitle = env.gitlabMergeRequestTitle ?: " "
                def mrId = env.gitlabMergeRequestIid
                def projectUrl = 'https://lab.ssafy.com/s12-final/S12P31A401'
                def mrUrl = "${projectUrl}/-/merge_requests/${mrId}"
                def msg = "âŒ BACKEND CI ì‹¤íŒ¨ <${env.BUILD_URL}|#${env.BUILD_NUMBER}>\n <${mrUrl}|${mrTitle}>"
                mattermostSend(color: 'danger',
                    message: msg,
                    endpoint: 'Mattermost ì±„ë„ Webhook'
                )
            }
        }
    } // post
  } // pipeline
  ```
- Back-CD
  - Source Branch Regex: `^dev-be$`
  - Target Branch Regex: `^develop$`
  ```
  pipeline {
    agent any
    environment {
        EC2_USER = credentials('ec2-user')
        EC2_HOST = credentials('ec2-host')
        
        IMAGE_TAG = "latest"
        DOCKER_REPO = "ë„ì»¤í—ˆë¸Œ ë ˆí¬ì§€í„°ë¦¬ëª…"
        IMAGE_NAME = "backend"
    }
    stages {
        stage('Checkout') {
            steps {
                script {
                    updateGitlabCommitStatus name: 'checkout', state: 'pending'
                    updateGitlabCommitStatus name: 'check-conflicts', state: 'pending'
                    updateGitlabCommitStatus name: 'build-jar', state: 'pending'
                    updateGitlabCommitStatus name: 'build-docker-image', state: 'pending'
                    updateGitlabCommitStatus name: 'push-docker-image', state: 'pending'
                    updateGitlabCommitStatus name: 'deploy-container', state: 'pending'
                    
                    def sourceBranch = env.gitlabSourceBranch
                    def targetBranch = env.gitlabTargetBranch
                    echo "MR Source Branch: ${sourceBranch}"
                    echo "MR Target Branch: ${targetBranch}"

                    checkout([$class: 'GitSCM',
                            branches: [[name: "*/${targetBranch}"]],
                            userRemoteConfigs: [[
                                url: 'https://lab.ssafy.com/s12-final/S12P31A401.git',
                                credentialsId: 'gitlab-account',
                                refspec: "+refs/heads/${sourceBranch}:refs/remotes/origin/${sourceBranch} +refs/heads/${targetBranch}:refs/remotes/origin/${targetBranch}"
                            ]]
                    ])
                    
                    updateGitlabCommitStatus name: 'checkout', state: 'success'
                    
                    sh '''
                    git config user.name "ci-bot"
                    git config user.email "ci@example.com"
                    '''

                    def mergeExitCode = sh(script: "git merge origin/${sourceBranch} --no-ff --no-commit --no-edit", returnStatus: true)
                    if (mergeExitCode != 0) {
                        error("âŒ Merge conflict ë°œìƒ: ${sourceBranch} â†’ ${targetBranch}")
                    } else {
                        echo "âœ… Merge ì„±ê³µ! ë¹Œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
                        updateGitlabCommitStatus name: 'check-conflicts', state: 'success'
                    }
                }
            }
        } // stage
        
        stage('Build JAR') {
            steps {
                script {
                    echo "âœ… Gradle í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹œì‘"

                     
                    sh '''
                    cd spicoBackend
                    chmod +x gradlew
                    ./gradlew clean processResources bootJar -x test
                    '''
                    
					echo "âœ… ë¹Œë“œ ì™„ë£Œ"
                    updateGitlabCommitStatus name: 'build-jar', state: 'success'
                    
                }
            }
        } // stage
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘"
                    sh '''
	                export PATH=$PATH:/usr/bin
					pwd
					cd spicoBackend
					ls
	                docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                    '''
                    echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: ${IMAGE_NAME}:${IMAGE_TAG}"
                    updateGitlabCommitStatus name: 'build-docker-image', state: 'success'
                }
            }
        }
        
        stage('Push Docker Image') {
			steps {
				script {
				    withCredentials([
		            usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')
				    ]) {
		            echo "âœ… Docker Hub ë¡œê·¸ì¸"
		            sh '''
                    echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
		            '''

		            echo "âœ… Docker ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±"
		            sh '''
                    docker tag "$IMAGE_NAME:$IMAGE_TAG" "$DOCKER_REPO:$IMAGE_TAG"
		            '''

		            echo "âœ… Docker Hubë¡œ ì´ë¯¸ì§€ í‘¸ì‹œ"
		            sh '''
                    docker push "$DOCKER_REPO:$IMAGE_TAG"
		            '''
				    }
				    updateGitlabCommitStatus name: 'push-docker-image', state: 'success'
				}
			}
		}
		
		stage('Connect to EC2 and Deploy') {
            steps {
                script {
                    withCredentials([file(credentialsId: 'backend-env', variable: 'ENV_PATH')]) {
                        def envVars = readFile("${ENV_PATH}")
                                        .split("\n")
                                        .findAll { it.trim() && !it.startsWith("#") }
                                        .collect { "-e ${it.trim()}" }
                                        .join(" ")
                        sshagent(['ssafy-ec2-ssh']) {
                            sh """
                            ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
                            echo "âœ… EC2ì— ì ‘ì† ì™„ë£Œ!"

                            sudo docker stop ${IMAGE_NAME} || true
                            sudo docker rm ${IMAGE_NAME} || true

                            # ìµœì‹  ë„ì»¤ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
                            sudo docker pull ${DOCKER_REPO}

                            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                            sudo docker run -d --name ${IMAGE_NAME} --network app-net ${envVars} -p :8080 -e TZ=Asia/Seoul ${DOCKER_REPO}
                            sudo docker network connect backend-net ${IMAGE_NAME}
                            sudo docker exec -it nginx nginx -s reload

                            echo "ğŸš€ ë„ì»¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì™„ë£Œ!"
                            """
                        }
                    }
                    updateGitlabCommitStatus name: 'deploy-container', state: 'success'
                }
            }
        }
    } // stages
    
    post {
        success {
            script {
                def mrTitle = env.gitlabMergeRequestTitle ?: " "
                def mrId = env.gitlabMergeRequestIid
                def projectUrl = 'https://lab.ssafy.com/s12-final/S12P31A401'
                def mrUrl = "${projectUrl}/-/merge_requests/${mrId}"
                def msg = "âœ… BACKEND CD ì„±ê³µ <${env.BUILD_URL}|#${env.BUILD_NUMBER}>\n <${mrUrl}|${mrTitle}>"
                mattermostSend(color: 'good',
                    message: msg,
                    endpoint: 'Mattermost ì±„ë„ Webhook'
                )
            }
        }
        failure {
            script {
                def mrTitle = env.gitlabMergeRequestTitle ?: " "
                def mrId = env.gitlabMergeRequestIid
                def projectUrl = 'https://lab.ssafy.com/s12-final/S12P31A401'
                def mrUrl = "${projectUrl}/-/merge_requests/${mrId}"
                def msg = "âŒ BACKEND CD ì„±ê³µ <${env.BUILD_URL}|#${env.BUILD_NUMBER}>\n <${mrUrl}|${mrTitle}>"
                mattermostSend(color: 'danger',
                    message: msg,
                    endpoint: 'Mattermost ì±„ë„ Webhook'
                )
            }
        }
    } // post
  } // pipeline
  ```
- Android-CI
  - Source Branch Regex: `.*`
  - Target Branch Regex: `^dev-and$`
  ```
  pipeline {
    agent any
    stages{
        stage('Checkout'){
            steps {
                script {
                    updateGitlabCommitStatus name: 'checkout', state: 'pending'
                    updateGitlabCommitStatus name: 'check-conflicts', state: 'pending'
                    updateGitlabCommitStatus name: 'build', state: 'pending'

                    def sourceBranch = env.gitlabSourceBranch
                    def targetBranch = env.gitlabTargetBranch
                    echo "MR Source Branch: ${sourceBranch}"
                    echo "MR Target Branch: ${targetBranch}"

                    checkout([$class: 'GitSCM',
                        branches: [[name: "*/${targetBranch}"]],
                        userRemoteConfigs: [[
                            url: 'https://lab.ssafy.com/s12-final/S12P31A401.git',
                            credentialsId: 'gitlab-account',
                            refspec: "+refs/heads/${sourceBranch}:refs/remotes/origin/${sourceBranch} +refs/heads/${targetBranch}:refs/remotes/origin/${targetBranch}"
                        ]]
                    ])
                    updateGitlabCommitStatus name: 'checkout', state: 'success'

                    sh '''
                    git config user.name "ci-bot"
                    git config user.email "ci@example.com"
                    '''

                    def mergeExitCode = sh(script: "git merge origin/${sourceBranch} --no-ff --no-commit --no-edit", returnStatus: true)
                    if (mergeExitCode != 0) {
                        error("âŒ Merge conflict ë°œìƒ: ${sourceBranch} â†’ ${targetBranch}")
                    } else {
                        echo "âœ… Merge ì„±ê³µ! ë¹Œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
                        updateGitlabCommitStatus name: 'check-conflicts', state: 'success'
                    }
                } //script
            } //steps
        } // Checkout stage
        
        stage('Build'){
             steps {
                 script {
                     echo "âœ… Android ë¹Œë“œ ì‹œì‘"

                     withCredentials([
                         file(credentialsId: 'android-properties', variable: 'ENV_FILE')
                     ]) {
                     sh """
                     rm -f spicoAndroid/local.properties
                     cp $ENV_FILE spicoAndroid/local.properties
                     cd spicoAndroid
                     chmod +x gradlew
                     ./gradlew clean assembleDebug
                     """
                     }
                    
                     echo "âœ… Android ë¹Œë“œ ì™„ë£Œ"
                     updateGitlabCommitStatus name: 'build', state: 'success'
                 }
             } // steps
         } // Build stage
    } //stages
    
    post {
        success {
            script {
                def mrTitle = env.gitlabMergeRequestTitle ?: " "
                def mrId = env.gitlabMergeRequestIid
                def projectUrl = 'https://lab.ssafy.com/s12-final/S12P31A401'
                def mrUrl = "${projectUrl}/-/merge_requests/${mrId}"
                def msg = "âœ… ANDROID CI ì„±ê³µ <${env.BUILD_URL}|#${env.BUILD_NUMBER}>\n <${mrUrl}|${mrTitle}>"
                mattermostSend(color: 'good',
                    message: msg,
                    endpoint: 'Mattermost ì±„ë„ Webhook'
                )
            }
        }
        failure {
            script {
                def mrTitle = env.gitlabMergeRequestTitle ?: " "
                def mrId = env.gitlabMergeRequestIid
                def projectUrl = 'https://lab.ssafy.com/s12-final/S12P31A401'
                def mrUrl = "${projectUrl}/-/merge_requests/${mrId}"
                def msg = "âŒ ANDROID CI ì‹¤íŒ¨ <${env.BUILD_URL}|#${env.BUILD_NUMBER}>\n <${mrUrl}|${mrTitle}>"
                mattermostSend(color: 'danger',
                    message: msg,
                    endpoint: 'Mattermost ì±„ë„ Webhook'
                )
            }
        }
    } // post
  } //pipeline
  ```

# ë°°í¬ ì‹œ íŠ¹ì´ì‚¬í•­
- deploy EC2ì— `spico` ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“  ë’¤ í•´ë‹¹ ë””ë ‰í† ë¦¬ ì•„ë˜ì— `docker-compose.yml`ê³¼ `/nginx/default.conf`ë¥¼ ë§Œë“ ë‹¤.
- monitoring EC2ì— `monitoring` ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“  ë’¤ í•´ë‹¹ ë””ë ‰í† ë¦¬ ì•„ë˜ì— `docker-compose.yml`ê³¼ `/loki/loki-config.yml`, `/prometheus/prometheus.yml`ë¥¼ ë§Œë“ ë‹¤.
- ê° ì»¨í…Œì´ë„ˆì˜ ìƒì„± ìˆœì„œì— ì£¼ì˜í•´ì•¼ í•œë‹¤.
- `.env`ì™€ `local.properties` íŒŒì¼ì˜ ë³€ê²½ ì‹œ ë°˜ë“œì‹œ Jenkins Credentialsì— ë°˜ì˜í•˜ì—¬ì•¼ í•œë‹¤.